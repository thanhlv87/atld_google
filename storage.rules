rules_version = '2';

service firebase.storage {
match /b/{bucket}/o {

    // === HÀM HỖ TRỢ ===
    function isAdmin() {
      return request.auth != null &&
             firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // Validate file size and type
    function validFileSize(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }

    function validFileType(allowedTypes) {
      return request.resource.contentType.matches(allowedTypes);
    }

    // === BLOG COVER IMAGES ===
    match /blog-covers/{imageId} {

      // Anyone can read blog cover images (public)
      allow read: if true;

      // Only admins can upload/update/delete blog covers
      allow create, update, delete: if isAdmin();
    }

    // === DOCUMENT UPLOADS ===
    match /documents/{documentId} {
      // Anyone can read/download documents
      allow read: if true;

      // Only admins can upload/update/delete documents
      // Validate file type and size for security
      allow create, update: if isAdmin() &&
                              validFileSize(10) &&
                              validFileType('(image/.*|application/pdf|application/msword|application/vnd\\..*|text/.*)');
      allow delete: if isAdmin();
    }

    // === QUOTE ATTACHMENTS ===
    match /quote-attachments/{attachmentId} {

      // Only authenticated partners can upload attachments
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // === CHAT ATTACHMENTS ===
    match /chat-attachments/{fileName} {
      // Authenticated users can read and upload chat attachments
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      // Users can only delete their own uploads (filename contains their uid)
      allow delete: if isAuthenticated() && request.auth.uid != null;
    }

    // === DEFAULT DENY ===
    match /{allPaths=**} {
      allow read, write: if false;
    }

  }

}